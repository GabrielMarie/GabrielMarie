<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Pr√©vision des aurores ‚Äì √† votre position</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <style>
    .card{background:#1115;border:1px solid #222;border-radius:16px;padding:16px;margin:16px 0;backdrop-filter:blur(4px)}
    .row{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:900px){.row{grid-template-columns:1.2fr 1fr}}
    .muted{color:#888;font-size:.9em}
    .big {font-size:1.25rem}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #333;margin-left:8px}
    .ok{background:#154;}.warn{background:#541;}.hot{background:#512;}
    .input-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    input[type="number"]{max-width:120px}
    canvas{max-height:420px}
  </style>
</head>
<body>
  <header>
    <div class="banner">
      <img id="siteBanner" src="le site de gab.gif" alt="Banni√®re">
      <div class="menu-toggle">‚ò∞</div>
    </div>
    <nav id="menu">
      <ul>
        <li><a href="home.html"><span class="pixel-gab">Accueil</span></a></li>
        <li><a href="math.html"><span class="pixel-gab">math</span></a></li>
        <li><a href="walker.html"><span class="pixel-gab">CAPITAINE&nbsp;Walker</span></a></li>
        <li><a href="expedition.html"><span class="pixel-gab">ExpEdition</span></a></li>
        <li><a href="projet.html"><span class="pixel-gab">Projet</span></a></li>
        <li><a href="aurore.html"><span class="pixel-gab">Aurore</span></a></li>
        <li><a href="dessin.html"><span class="pixel-gab">Dessin</span></a></li>
        <li><a href="contact.html"><span class="pixel-gab">Contact</span></a></li>
      </ul>
    </nav>
  </header>
  <header>
    <h1>Aurores bor√©ales</h1>
  </header>

  <main>
    <section class="sujet">
      <h2>üåå Pr√©vision des Aurores</h2>
      <p class="muted">Donn√©es : NOAA SWPC (Kp 1-minute, Kp pr√©visionnel 3 jours, mod√®le OVATION).</p>

      <div class="card">
        <div id="kp-live" class="big">üì° Lecture Kp (1-minute)‚Ä¶</div>
        <div id="kp-live-note" class="muted">Horodatage √† l‚ÄôUTC, mis √† jour en continu.</div>
      </div>

      <div class="card">
        <h3>üéØ Probabilit√© √† votre position (OVATION, ‚Äúmaintenant‚Äù)</h3>
        <p id="loc-status" class="muted">Tentative de g√©olocalisation du navigateur‚Ä¶</p>
        <div class="input-group">
          <label>Lat&nbsp;<input id="lat" type="number" step="0.01" placeholder="46.82"></label>
          <label>Lon&nbsp;<input id="lon" type="number" step="0.01" placeholder="-71.23"></label>
          <button id="btnManual">Mettre √† jour</button>
        </div>
        <p id="ovation-now" class="big">‚Äî</p>
        <div id="ovation-extra" class="muted"></div>
      </div>

      <div class="row">
        <div class="card">
          <h3>üìà Kp pr√©visionnel ‚Äî Prochaines 72 heures (√©chelons 3 h)</h3>
          <canvas id="kp-forecast-chart"></canvas>
          <p class="muted" id="kp-forecast-note"></p>
        </div>

        <div class="card">
          <h3>‚ÑπÔ∏è Interpr√©tation rapide du Kp</h3>
          <ul>
            <li><b>Kp 0‚Äì2</b> : aurores surtout au-del√† de ~60‚Äì65¬∞N.</li>
            <li><b>Kp 3‚Äì4</b> : possibles au-del√† de ~55‚Äì60¬∞N.</li>
            <li><b>Kp 5 (G1)</b> : parfois visibles ~50‚Äì55¬∞N.</li>
            <li><b>Kp 6‚Äì7</b> : peuvent descendre ~45‚Äì50¬∞N.</li>
            <li><b>Kp ‚â•8</b> : √©pisodes majeurs, visibles bien plus au sud.</li>
          </ul>
          <p class="muted">Ces seuils sont approximatifs ; OVATION est plus pr√©cis car il mod√©lise l‚Äôovale auroral en temps quasi r√©el.</p>
        </div>
      </div>

      <p class="muted">Source Kp et OVATION : NOAA SWPC (JSON public). Les appels peuvent passer par un worker Cloudflare si d√©fini.</p>
    </section>
  </main>

<script>
// ------- CONFIG (mets ton worker ici si tu veux passer par un proxy) -------
const PROXY_BASE = "https://aurora-proxy.gabrielmarie.workers.dev/?url=";

// ------- HELPERS -------
const el = (id) => document.getElementById(id);
const fmtUTC = (iso) => {
  try{
    return new Date(iso).toLocaleString('fr-CA', { timeZone:'UTC', hour12:false, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }) + ' UTC';
  }catch{return iso}
};
const kpColor = (kp) => kp<3 ? '#1e90ff' : kp<5 ? '#4caf50' : kp<7 ? '#ff9800' : '#f44336';

async function fetchWithFallback(url){
  try{
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  }catch(e){
    if(!PROXY_BASE) throw e;
    const r2 = await fetch(PROXY_BASE + encodeURIComponent(url), {cache:"no-store"});
    if(!r2.ok) throw new Error("PROXY HTTP "+r2.status);
    return await r2.json();
  }
}

// ------- NOAA endpoints -------
const NOAA = {
  KP_1M: "https://services.swpc.noaa.gov/json/planetary_k_index_1m.json",
  KP_FC3D: "https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json",
  OVATION: "https://services.swpc.noaa.gov/json/ovation_aurora_latest.json"
};
// Remplace la fonction par un wrapper qui utilise le parseur robuste :
const loadOvationAt = (lat, lon) => __loadOvationAtRobust(fetchWithFallback, NOAA.OVATION, lat, lon);

// ------- OVATION parser (g√®re 2 formats) -------
function extractOvationCells(raw){
  if (Array.isArray(raw) && raw.length && typeof raw[0]==="object" && "lat" in raw[0] && "lon" in raw[0]) {
    return raw.map(o=>({lat:+o.lat, lon:+o.lon, intensity:+(o.intensity ?? o.probability ?? 0), time:o.time || o["Observation Time"] || null}));
  }
  if (raw && raw.type==="FeatureCollection" && Array.isArray(raw.features)) {
    const cells=[];
    for (const f of raw.features){
      const props=f.properties||{};
      const coords=f.geometry?.coordinates||[];
      const flat=coords.flat(3);
      for(let i=0;i+2<flat.length;i+=3){
        const lon=+flat[i], lat=+flat[i+1], intensity=+flat[i+2];
        if(Number.isFinite(lat)&&Number.isFinite(lon)&&Number.isFinite(intensity)){
          cells.push({lat,lon,intensity,time:props.time||null});
        }
      }
    }
    return cells;
  }
  return [];
}
function normalizeLonDiff(d){ while(d>180)d-=360; while(d<-180)d+=360; return d; }

// ------- 1) Kp live (1-minute) -------
async function loadKpLive(){
  try{
    const data = await fetchWithFallback(NOAA.KP_1M);
    const last = data[data.length - 1];
    const kp = parseFloat(last.kp_index);
    el('kp-live').innerHTML = `üì° Indice Kp (1‚Äëmin) : <b>${kp.toFixed(1)}</b> <span class="pill" style="background:${kpColor(kp)}">Kp</span>`;
    el('kp-live-note').textContent = `Mesur√© ${fmtUTC(last.time_tag)}.`;
  }catch(e){
    el('kp-live').textContent = '‚ùå Impossible de r√©cup√©rer le Kp 1‚Äëminute.';
    console.warn(e);
  }
}

// ------- 2) OVATION ‚Äúmaintenant‚Äù -------
async function loadOvationAt(lat, lon){
  try{
    el('ovation-now').textContent = 'Calcul en cours‚Ä¶';
    const raw = await fetchWithFallback(NOAA.OVATION);
    const ov = extractOvationCells(raw);
    if(!ov.length) throw new Error('Grille OVATION introuvable');
    let best=null, bestD=1e9;
    for(const cell of ov){
      const d = Math.hypot(lat - cell.lat, normalizeLonDiff(lon - cell.lon));
      if(d < bestD){ bestD = d; best = cell; }
    }
    const p = Math.max(0, Math.min(100, +best.intensity || 0));
    el('ovation-now').innerHTML =
      `Probabilit√© √† <b>${lat.toFixed(2)}¬∞, ${lon.toFixed(2)}¬∞</b> : <b>${p.toFixed(0)} %</b> ` +
      `<span class="pill ${p<25?'ok':p<60?'warn':'hot'}">${p<25?'faible':p<60?'moyenne':'√©lev√©e'}</span>`;
    el('ovation-extra').textContent = `Derni√®re mise √† jour mod√®le : ${fmtUTC(best.time || new Date().toISOString())}.`;
  }catch(e){
    el('ovation-now').textContent = '‚ùå Impossible de calculer la probabilit√© OVATION.';
    console.warn(e);
  }
}
function geolocateAndLoad(){
  const status = el('loc-status');
  if(!navigator.geolocation){
    status.textContent = 'G√©olocalisation navigateur indisponible ‚Äî entrez la latitude/longitude manuellement.';
    return;
  }
  status.textContent = 'Demande d‚Äôautorisation de g√©olocalisation‚Ä¶';
  navigator.geolocation.getCurrentPosition((pos)=>{
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    status.textContent = `Position d√©tect√©e : ${lat.toFixed(3)}¬∞, ${lon.toFixed(3)}¬∞.`;
    el('lat').value = lat.toFixed(3);
    el('lon').value = lon.toFixed(3);
    loadOvationAt(lat, lon);
  }, (_err)=>{
    status.textContent = 'Acc√®s refus√© ‚Äî entrez la latitude/longitude ci-dessus puis cliquez ‚ÄúMettre √† jour‚Äù.';
  }, { enableHighAccuracy:true, timeout:8000, maximumAge:300000 });
}
el('btnManual').addEventListener('click', ()=>{
  const lat = parseFloat(el('lat').value), lon = parseFloat(el('lon').value);
  if(Number.isFinite(lat) && Number.isFinite(lon)){
    loadOvationAt(lat, lon);
    el('loc-status').textContent = `Position d√©finie manuellement : ${lat.toFixed(3)}¬∞, ${lon.toFixed(3)}¬∞.`;
  }
});

// ------- 3) Kp forecast 3 jours -------
async function loadKpForecast(){
  const note = el('kp-forecast-note');
  try{
    const rows = await fetchWithFallback(NOAA.KP_FC3D);
    const head = rows[0];
    const idxTime = head.indexOf('time_tag');
    const idxKp = head.indexOf('kp_forecast');
    const data = rows.slice(1).map(r=>({ t:r[idxTime], kp: +r[idxKp] }));

    const labels = data.map(d=> new Date(d.t).toLocaleString(undefined, {month:'2-digit', day:'2-digit', hour:'2-digit'}));
    const values = data.map(d=> d.kp);

    const ctx = document.getElementById('kp-forecast-chart');
    if(ctx._chart){ ctx._chart.destroy(); }
    ctx._chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Pr√©vision Kp (3 h)', data: values, backgroundColor: values.map(kpColor) }]},
      options: {
        animation:false,
        scales: { y: { min:0, max:9, ticks:{ stepSize:1 } } },
        plugins: { legend: { display:false }, tooltip: { callbacks:{ label:(c)=> `Kp ${c.raw}` } } }
      }
    });

    if(data.length){
      note.textContent = `Fen√™tre de pr√©vision : ${fmtUTC(data[0].t)} ‚Üí ${fmtUTC(data[data.length-1].t)}.`;
    }
  }catch(e){
    note.textContent = '‚ùå Impossible de charger la pr√©vision Kp 3 jours.';
    console.warn(e);
  }
}

// ------- Start -------
loadKpLive();
geolocateAndLoad();
loadKpForecast();
setInterval(loadKpLive, 5*60*1000);
</script>
<script src="ovation_fix.js"></script>

</body>
</html>
