<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Pr√©vision des aurores ‚Äì √† votre position</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js (une seule fois suffit ; si d√©j√† inclus globalement, tu peux supprimer cette ligne) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
<header>
    <div class="banner">
      <img id="siteBanner" src="le site de gab.gif" alt="Banni√®re">
      <div class="menu-toggle">‚ò∞</div>
    </div>
    <nav id="menu">
      <ul>
        <li><a href="home.html"><span class="pixel-gab">Accueil</span></a></li>
        <li><a href="math.html"><span class="pixel-gab">math</span></a></li>
        <li><a href="walker.html"><span class="pixel-gab">CAPITAINE&nbsp;Walker</span></a></li>
        <li><a href="expedition.html"><span class="pixel-gab">ExpEdition</span></a></li>
            <!-- <li><a href="securitephysique.html"><span class="pixel-gab">Securite</span></a></li> -->
        <li><a href="projet.html"><span class="pixel-gab">Projet</span></a></li>
        <li><a href="aurore.html"><span class="pixel-gab">Aurore</span></a></li>
        <li><a href="dessin.html"><span class="pixel-gab">Dessin</span></a></li>
        <li><a href="contact.html"><span class="pixel-gab">Contact</span></a></li>
      </ul>
    </nav>
  </header>
  <style>
    .card{background:#1115;border:1px solid #222;border-radius:16px;padding:16px;margin:16px 0;backdrop-filter:blur(4px)}
    .row{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:900px){.row{grid-template-columns:1.2fr 1fr}}
    .muted{color:#888;font-size:.9em}
    .big {font-size:1.25rem}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #333;margin-left:8px}
    .ok{background:#154;}.warn{background:#541;}.hot{background:#512;}
    .input-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    input[type="number"]{max-width:120px}
    canvas{max-height:420px}
  </style>
</head>
<body>
<header>
  <h1>Aurores bor√©ales</h1>
</header>

<main>
  <section class="sujet">
    <h2>üåå Pr√©vision des Aurores</h2>
    <p class="muted">Donn√©es : NOAA SWPC (Kp 1-minute, Kp pr√©visionnel 3 jours, mod√®le OVATION).</p>

    <div class="card">
      <div id="kp-live" class="big">üì° Lecture Kp (1-minute)‚Ä¶</div>
      <div id="kp-live-note" class="muted">Horodatage √† l‚ÄôUTC, mis √† jour en continu.</div>
    </div>

    <div class="card">
      <h3>üéØ Probabilit√© √† votre position (OVATION, ‚Äúmaintenant‚Äù)</h3>
      <p id="loc-status" class="muted">Tentative de g√©olocalisation du navigateur‚Ä¶</p>
      <div class="input-group">
        <label>Lat&nbsp;<input id="lat" type="number" step="0.01" placeholder="46.82"></label>
        <label>Lon&nbsp;<input id="lon" type="number" step="0.01" placeholder="-71.23"></label>
        <button id="btnManual">Mettre √† jour</button>
      </div>
      <p id="ovation-now" class="big">‚Äî</p>
      <div id="ovation-extra" class="muted"></div>
    </div>

    <div class="row">
      <div class="card">
        <h3>üìà Kp pr√©visionnel ‚Äî Prochaines 72 heures (√©chelons 3 h)</h3>
        <canvas id="kp-forecast-chart"></canvas>
        <p class="muted" id="kp-forecast-note"></p>
      </div>

      <div class="card">
        <h3>‚ÑπÔ∏è Interpr√©tation rapide du Kp</h3>
        <ul>
          <li><b>Kp 0‚Äì2</b> : aurores surtout au-del√† de ~60‚Äì65¬∞N.</li>
          <li><b>Kp 3‚Äì4</b> : possibles au-del√† de ~55‚Äì60¬∞N.</li>
          <li><b>Kp 5 (G1)</b> : parfois visibles ~50‚Äì55¬∞N.</li>
          <li><b>Kp 6‚Äì7</b> : peuvent descendre ~45‚Äì50¬∞N.</li>
          <li><b>Kp ‚â•8</b> : √©pisodes majeurs, visibles bien plus au sud.</li>
        </ul>
        <p class="muted">Ces seuils sont approximatifs ; OVATION est plus pr√©cis car il mod√©lise l‚Äôovale auroral en temps quasi r√©el.</p>
      </div>
    </div>

    <p class="muted">Source Kp et OVATION : NOAA SWPC (JSON public). Les appels passent par ton worker Cloudflare pour √©viter le CORS.</p>
  </section>
</main>

<script>
(function(){
  // --- Utilitaires ---
  const proxy = (url) =>
    `https://muddy-cell-637b.gabriel-saint-gelais.workers.dev/?url=${encodeURIComponent(url)}`;

  const el = (id) => document.getElementById(id);

  const fmtUTC = (iso) => {
    try{
      return new Date(iso).toLocaleString('fr-CA', { timeZone: 'UTC', hour12: false,
        year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }) + ' UTC';
    }catch{return iso}
  };

  const kpColor = (kp) => {
    if (kp < 3) return '#1e90ff';   // calme
    if (kp < 5) return '#4caf50';   // mod√©r√©
    if (kp < 7) return '#ff9800';   // actif
    return '#f44336';               // temp√™te
  };

  // --- 1) Kp "quasi temps r√©el" (s√©rie 1-minute) ---
  async function loadKpLive(){
    // SWPC: Planetary K-index 1-minute JSON
    // https://services.swpc.noaa.gov/json/planetary_k_index_1m.json
    try{
      const res = await fetch(proxy('https://services.swpc.noaa.gov/json/planetary_k_index_1m.json'));
      const data = await res.json();
      const last = data[data.length - 1];
      const kp = parseFloat(last.kp_index);
      el('kp-live').innerHTML = `üì° Indice Kp (1-min) : <b>${kp.toFixed(1)}</b> <span class="pill" style="background:${kpColor(kp)}">Kp</span>`;
      el('kp-live-note').textContent = `Mesur√© ${fmtUTC(last.time_tag)}.`;
    }catch(e){
      el('kp-live').textContent = '‚ùå Impossible de r√©cup√©rer le Kp 1-minute.';
      console.warn(e);
    }
  }

  // --- 2) OVATION "maintenant" √† la position de l‚Äôutilisateur ---
  // JSON : https://services.swpc.noaa.gov/json/ovation_aurora_latest.json
  async function loadOvationAt(lat, lon){
    try{
      el('ovation-now').textContent = 'Calcul en cours‚Ä¶';
      const res = await fetch(proxy('https://services.swpc.noaa.gov/json/ovation_aurora_latest.json'));
      const ov = await res.json();
      // ov.grid : tableau de {lat, lon, intensity} (0‚Äì100). On cherche la cellule la plus proche.
      let best=null, bestD=1e9;
      for(const cell of ov){
        if(!('lat' in cell && 'lon' in cell && 'intensity' in cell)) continue;
        const d = Math.hypot(lat - cell.lat, normalizeLonDiff(lon - cell.lon));
        if(d < bestD){ bestD = d; best = cell; }
      }
      if(!best){ throw new Error('Grille OVATION introuvable'); }
      const p = Math.max(0, Math.min(100, +best.intensity || 0));
      el('ovation-now').innerHTML =
        `Probabilit√© √† <b>${lat.toFixed(2)}¬∞, ${lon.toFixed(2)}¬∞</b> : <b>${p.toFixed(0)} %</b> ` +
        `<span class="pill ${p<25?'ok':p<60?'warn':'hot'}">${p<25?'faible':p<60?'moyenne':'√©lev√©e'}</span>`;
      el('ovation-extra').textContent = `Derni√®re mise √† jour mod√®le : ${fmtUTC(best['Observation Time'] || best.time || new Date().toISOString())}.`;
    }catch(e){
      el('ovation-now').textContent = '‚ùå Impossible de calculer la probabilit√© OVATION.';
      console.warn(e);
    }
  }
  function normalizeLonDiff(d){ // tenir compte de la discontinuit√© +/-180
    while(d>180) d-=360;
    while(d<-180) d+=360;
    return d;
  }

  async function geolocateAndLoad(){
    const status = el('loc-status');
    if(!navigator.geolocation){
      status.textContent = 'G√©olocalisation navigateur indisponible ‚Äî entrez la latitude/longitude manuellement.';
      return;
    }
    status.textContent = 'Demande d‚Äôautorisation de g√©olocalisation‚Ä¶';
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      status.textContent = `Position d√©tect√©e : ${lat.toFixed(3)}¬∞, ${lon.toFixed(3)}¬∞.`;
      el('lat').value = lat.toFixed(3);
      el('lon').value = lon.toFixed(3);
      loadOvationAt(lat, lon);
    }, (_err)=>{
      status.textContent = 'Acc√®s refus√© ‚Äî entrez la latitude/longitude ci-dessus puis cliquez ‚ÄúMettre √† jour‚Äù.';
    }, { enableHighAccuracy:true, timeout:8000, maximumAge:300000 });
  }

  el('btnManual').addEventListener('click', ()=>{
    const lat = parseFloat(el('lat').value), lon = parseFloat(el('lon').value);
    if(Number.isFinite(lat) && Number.isFinite(lon)){
      loadOvationAt(lat, lon);
      el('loc-status').textContent = `Position d√©finie manuellement : ${lat.toFixed(3)}¬∞, ${lon.toFixed(3)}¬∞.`;
    }
  });

  // --- 3) Kp pr√©visionnel 3 jours (barres 3 h) ---
  // JSON : https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json
  async function loadKpForecast(){
    const note = el('kp-forecast-note');
    try{
      const res = await fetch(proxy('https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json'));
      const rows = await res.json(); // premi√®re ligne = header, le reste = data
      const head = rows[0];
      const idxTime = head.indexOf('time_tag');
      const idxKp = head.indexOf('kp_forecast');
      const data = rows.slice(1).map(r=>({ t:r[idxTime], kp: +r[idxKp] }));

      const labels = data.map(d=> new Date(d.t).toLocaleString(undefined, {
        month:'2-digit', day:'2-digit', hour:'2-digit'
      }));
      const values = data.map(d=> d.kp);

      const ctx = document.getElementById('kp-forecast-chart');
      // D√©truit un √©ventuel graphe existant si on recharge la page
      if(ctx._chart){ ctx._chart.destroy(); }
      ctx._chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Pr√©vision Kp (3 h)',
            data: values,
            backgroundColor: values.map(kpColor)
          }]
        },
        options: {
          animation:false,
          scales: {
            y: { min:0, max:9, ticks:{ stepSize:1 } }
          },
          plugins: {
            legend: { display:false },
            tooltip: {
              callbacks:{
                label:(c)=> `Kp ${c.raw}`
              }
            }
          }
        }
      });

      if(data.length){
        const t0 = data[0].t, tn = data[data.length-1].t;
        note.textContent = `Fen√™tre de pr√©vision : ${fmtUTC(t0)} ‚Üí ${fmtUTC(tn)}.`;
      }
    }catch(e){
      note.textContent = '‚ùå Impossible de charger la pr√©vision Kp 3 jours.';
      console.warn(e);
    }
  }

  // --- go ---
  loadKpLive();
  geolocateAndLoad();
  loadKpForecast();
  // refresh live Kp toutes 5 min (hard refresh l√©ger)
  setInterval(loadKpLive, 5*60*1000);
})();
</script>
</body>
</html>