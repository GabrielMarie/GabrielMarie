<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pr√©vision des aurores ‚Äî √† votre position</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root{
      --bg:#0c0f14; --fg:#e8eef6; --muted:#94a3b8; --card:#121826; --br:#1f2937; --accent:#6ea8fe;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
    header.page{padding:18px 16px;border-bottom:1px solid var(--br);display:flex;align-items:center;gap:12px}
    header.page h1{margin:0;font-size:1.6rem}
    header.page .spacer{flex:1}
    header.page button{background:#1e293b;border:1px solid var(--br);color:var(--fg);border-radius:12px;padding:8px 12px;cursor:pointer}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--br);border-radius:16px;padding:16px;margin:16px 0}
    .row{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:900px){.row{grid-template-columns:1.2fr 1fr}}
    .muted{color:var(--muted);font-size:.9rem}
    .pill{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid var(--br);margin-left:8px}
    .ok{background:#0f5132}.warn{background:#664d03}.hot{background:#842029}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    canvas{max-height:420px}
    .kptitle{display:flex;align-items:center;gap:8px}
    .dot{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#1e293b;border:1px solid var(--br);cursor:pointer;font-size:12px}
    .tooltip{position:relative;display:inline-block}
    .tooltip .tip{display:none;position:absolute;top:calc(100% + 6px);left:0;background:#0b1220;border:1px solid var(--br);color:var(--fg);padding:8px;border-radius:10px;max-width:320px;z-index:20}
    .tooltip:hover .tip{display:block}
    /* Drawer */
    .drawer{position:fixed;inset:0;display:none}
    .drawer.open{display:block}
    .drawer .backdrop{position:absolute;inset:0;background:#0008}
    .drawer .panel{position:absolute;right:0;top:0;height:100%;width:min(480px,100%);background:var(--card);border-left:1px solid var(--br);padding:16px;overflow:auto}
    .drawer h3{margin-top:0}
    .drawer .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input[type="number"], select{background:#0b1220;border:1px solid var(--br);color:var(--fg);border-radius:10px;padding:6px;width:100%}
    .btn{background:#1e293b;border:1px solid var(--br);color:var(--fg);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:disabled{opacity:.7;cursor:not-allowed}
    #minimap{height:260px;border-radius:12px;border:1px solid var(--br);margin-top:8px}
    .note{font-size:.85rem;color:var(--muted)}
  </style>
</head>
<body>
    <header>
    <div class="banner">
      <img id="siteBanner" src="le site de gab.gif" alt="Banni√®re">
      <div class="menu-toggle">‚ò∞</div>
    </div>
    <nav id="menu">
      <ul>
        <li><a href="home.html"><span class="pixel-gab">Accueil</span></a></li>
        <li><a href="math.html"><span class="pixel-gab">math</span></a></li>
        <li><a href="walker.html"><span class="pixel-gab">CAPITAINE&nbsp;Walker</span></a></li>
        <li><a href="expedition.html"><span class="pixel-gab">ExpEdition</span></a></li>
        <li><a href="projet.html"><span class="pixel-gab">Projet</span></a></li>
        <li><a href="aurore.html"><span class="pixel-gab">Aurore</span></a></li>
        <li><a href="dessin.html"><span class="pixel-gab">Dessin</span></a></li>
        <li><a href="contact.html"><span class="pixel-gab">Contact</span></a></li>
      </ul>
    </nav>
  </header>

  <header class="page">
    <h1>Pr√©vision des Aurores</h1>
    <div class="spacer"></div>
    <button id="btnSettings">‚öôÔ∏è Param√®tres</button>
  </header>

  <main>
    <!-- Combined card: Kp live + Probability at position -->
    <section class="card" id="status-card">
      <div class="grid2">
        <div>
          <div class="kptitle">
            <div class="tooltip">
              <span class="dot">?</span>
              <div class="tip">Indice g√©omagn√©tique Kp estim√© (NOAA, s√©rie 1‚Äëminute). Plus Kp est √©lev√©, plus l‚Äôovale auroral s‚Äô√©tend vers le sud.</div>
            </div>
            <h3 style="margin:0">Kp actuel</h3>
          </div>
          <p id="kp-live" class="mono" style="font-size:1.2rem;margin:.35rem 0">Lecture‚Ä¶</p>
          <p id="kp-live-note" class="muted">‚Äî</p>
        </div>
        <div>
          <div class="kptitle">
            <div class="tooltip">
              <span class="dot">?</span>
              <div class="tip">Probabilit√© d‚Äôaurore √† votre position d‚Äôapr√®s le mod√®le OVATION (grille NOAA). On prend la cellule la plus proche de vos coordonn√©es.</div>
            </div>
            <h3 style="margin:0">Probabilit√© √† votre position</h3>
          </div>
          <p id="ovation-now" class="mono" style="font-size:1.2rem;margin:.35rem 0">‚Äî</p>
          <p id="pos-line" class="muted">‚Äî</p>
        </div>
      </div>
    </section>

    <section class="row">
      <div class="card">
        <div class="kptitle">
          <div class="tooltip">
            <span class="dot">?</span>
            <div class="tip">Pr√©visions Kp NOAA sur 3 jours en pas de 3 h. Choisissez l‚Äôaffichage Local/UTC dans les param√®tres.</div>
          </div>
          <h3 style="margin:0">Kp pr√©visionnel ‚Äî prochaines 72 h</h3>
        </div>
        <canvas id="kp-forecast-chart"></canvas>
        <p class="muted" id="kp-forecast-note"></p>
      </div>

      <div class="card">
        <h3 style="margin:0">‚ÑπÔ∏è Guide express</h3>
        <ul class="note">
          <li><b>Kp 0‚Äì2</b> : aurores surtout &gt;60‚Äì65¬∞N</li>
          <li><b>Kp 3‚Äì4</b> : possibles &gt;55‚Äì60¬∞N</li>
          <li><b>Kp 5 (G1)</b> : parfois visibles ~50‚Äì55¬∞N</li>
          <li><b>Kp 6‚Äì7</b> : jusqu‚Äô√† ~45‚Äì50¬∞N</li>
          <li><b>Kp ‚â•8</b> : √©pisodes majeurs</li>
        </ul>
        <p class="note">Cliquez sur les ‚Äú?‚Äù pour plus de d√©tails.</p>
      </div>
    </section>
  </main>

  <!-- Settings Drawer -->
  <div class="drawer" id="drawer">
    <div class="backdrop" id="closeDrawer"></div>
    <div class="panel">
      <div style="display:flex;align-items:center;gap:8px">
        <h3 style="margin:0">Param√®tres</h3>
        <div class="spacer"></div>
        <button class="btn" id="btnClose">Fermer</button>
      </div>
      <hr style="border-color:var(--br)">

      <h4>Affichage des heures</h4>
      <div class="row2">
        <label>Fuseau du graphique
          <select id="tzMode">
            <option value="local">Heure locale</option>
            <option value="utc">UTC</option>
          </select>
        </label>
      </div>

      <h4 style="margin-top:16px">Position de l‚Äôobservateur</h4>
      <div class="row2">
        <label>Latitude
          <input id="lat" type="number" step="0.01" placeholder="46.82">
        </label>
        <label>Longitude
          <input id="lon" type="number" step="0.01" placeholder="-71.23">
        </label>
      </div>
      <button class="btn" id="btnUseGeo" style="margin-top:8px">üìç Utiliser ma position</button>
      <div id="minimap"></div>
      <p class="note">D√©placez le marqueur ou saisissez lat/lon. Cliquez ‚ÄúAppliquer‚Äù pour recalculer la probabilit√©.</p>
      <button class="btn" id="btnApply">Appliquer</button>
    </div>
  </div>

<script>
// ------------- CONFIG -------------
const PROXY_BASE = ""; // ex: "https://TON-WORKER.workers.dev/?url="
const NOAA = {
  KP_1M: "https://services.swpc.noaa.gov/json/planetary_k_index_1m.json",
  KP_FC3D: "https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json",
  OVATION: "https://services.swpc.noaa.gov/json/ovation_aurora_latest.json"
};

// ------------- HELPERS -------------
const $ = (id)=>document.getElementById(id);
function fetchWithFallback(url){
  return fetch(url,{cache:"no-store"}).then(r=>{
    if(r.ok) return r.json();
    if(!PROXY_BASE) throw new Error("HTTP "+r.status);
    return fetch(PROXY_BASE + encodeURIComponent(url), {cache:"no-store"}).then(r2=>{
      if(!r2.ok) throw new Error("PROXY HTTP "+r2.status);
      return r2.json();
    });
  }).catch(e=>{
    if(!PROXY_BASE) throw e;
    return fetch(PROXY_BASE + encodeURIComponent(url), {cache:"no-store"}).then(r2=>{
      if(!r2.ok) throw new Error("PROXY HTTP "+r2.status);
      return r2.json();
    });
  });
}
const fmt = {
  tzMode: localStorage.getItem("tzMode") || "local",
  label(ts){
    const d = new Date(ts);
    const opts = {month:'2-digit',day:'2-digit',hour:'2-digit'};
    if(this.tzMode==='utc') opts.timeZone='UTC';
    return d.toLocaleString(undefined, opts);
  },
  utcStamp(ts){
    return new Date(ts).toLocaleString('fr-CA',{timeZone:'UTC',hour12:false,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})+" UTC";
  }
};
function setTzMode(v){
  fmt.tzMode = v;
  localStorage.setItem("tzMode", v);
  loadKpForecast(true);
}
function degToCardinal(lat, lon){
  const ns = lat>=0 ? "N" : "S";
  const ew = lon>=0 ? "E" : "O";
  return `${Math.abs(lat).toFixed(3)}¬∞ ${ns}, ${Math.abs(lon).toFixed(3)}¬∞ ${ew}`;
}
// Robust scan for OVATION triplets [lon,lat,intensity]
function scanTriplets(node, out){
  if(!node) return;
  if(Array.isArray(node)){
    if(node.length===3 && node.every(v=>typeof v==="number")){
      const [lon,lat,val]=node;
      if(lon>=-180 && lon<=180 && lat>=-90 && lat<=90 && isFinite(val)){
        out.push({lat,lon,intensity:+val});
      }
    }
    for(const v of node) scanTriplets(v,out);
    return;
  }
  if(typeof node==="object"){
    for(const k in node) scanTriplets(node[k], out);
  }
}
async function loadOvation(lat, lon){
  const out = $("ovation-now"), posline=$("pos-line");
  out.textContent = "Calcul‚Ä¶";
  posline.textContent = degToCardinal(lat, lon);
  try{
    const raw = await fetchWithFallback(NOAA.OVATION);
    let cells = [];
    if(Array.isArray(raw) && raw.length && raw[0] && typeof raw[0]==="object" && "lat" in raw[0]){
      const keyLat = ["lat","latitude","Lat","Latitude"].find(k=>k in raw[0]) || "lat";
      const keyLon = ["lon","longitude","Lon","Longitude"].find(k=>k in raw[0]) || "lon";
      const keyVal = ["intensity","probability","value","Intensity","Value"].find(k=>k in raw[0]) || "intensity";
      cells = raw.map(o=>({lat:+o[keyLat], lon:+o[keyLon], intensity:+o[keyVal], time:o.time || o["Observation Time"] || null}));
    }else{
      scanTriplets(raw, cells);
    }
    if(!cells.length) throw new Error("OVATION: aucune cellule trouv√©e");
    let best=null, bestD=1e9;
    for(const c of cells){
      const dx = lat - c.lat, dy = lon - c.lon;
      const d = Math.hypot(dx, ((dy+540)%360)-180); // wrap lon diff
      if(d<bestD){bestD=d;best=c;}
    }
    const p = Math.max(0, Math.min(100, +best.intensity || 0));
    const cls = p<25?'ok':p<60?'warn':'hot';
    out.innerHTML = `Probabilit√© √† cette position : <b>${p.toFixed(0)}‚ÄØ%</b> <span class="pill ${cls}">${p<25?'faible':p<60?'moyenne':'√©lev√©e'}</span>`;
  }catch(e){
    console.error(e);
    out.textContent = "‚ùå Impossible de calculer la probabilit√© OVATION.";
  }
}

// ------------- DATA LOADERS -------------
async function loadKpLive(){
  try{
    const data = await fetchWithFallback(NOAA.KP_1M);
    const last = data[data.length-1];
    const kp = parseFloat(last.kp_index);
    document.getElementById("kp-live").innerHTML = `Kp (1‚Äëmin) : <b>${kp.toFixed(1)}</b> <span class="pill" style="background:${ kp<3?'#1e90ff':kp<5?'#4caf50':kp<7?'#ff9800':'#f44336' }">Kp</span>`;
    document.getElementById("kp-live-note").textContent = `Mesur√© ${fmt.utcStamp(last.time_tag)}.`;
  }catch(e){
    console.error(e);
    document.getElementById("kp-live").textContent = "‚ùå Kp indisponible";
  }
}

let chartRef=null, lastForecast=[];
async function loadKpForecast(redrawOnly=false){
  const note = document.getElementById("kp-forecast-note");
  try{
    if(!redrawOnly){
      const rows = await fetchWithFallback(NOAA.KP_FC3D);
      const header = rows[0].map(h=>String(h).toLowerCase());
      const iT = header.indexOf("time_tag");
      const iK = header.indexOf("kp_forecast");
      const data = rows.slice(1).map(r=>({t:r[iT], kp:+r[iK]})).filter(x=>Number.isFinite(x.kp));
      lastForecast = data;
      if(!data.length) throw new Error("Pr√©vision vide");
      const t0 = data[0].t, tn = data[data.length-1].t;
      note.textContent = `Fen√™tre de pr√©vision : ${fmt.utcStamp(t0)} ‚Üí ${fmt.utcStamp(tn)}.`;
    }
    const labels = lastForecast.map(d=> fmt.label(d.t));
    const values = lastForecast.map(d=> d.kp);
    const ctx = document.getElementById("kp-forecast-chart");
    if(chartRef){ chartRef.destroy(); }
    chartRef = new Chart(ctx, {
      type:"bar",
      data:{ labels, datasets:[{ label:"Kp (3‚ÄØh)", data:values }]},
      options:{
        animation:false,
        scales:{ y:{min:0,max:9,ticks:{stepSize:1}}},
        plugins:{ legend:{display:false}, tooltip:{callbacks:{label:(c)=>"Kp "+c.raw}} }
      }
    });
  }catch(e){
    console.error(e);
    note.textContent = "‚ùå Impossible de charger la pr√©vision Kp 3 jours.";
  }
}

// ------------- SETTINGS DRAWER + MAP -------------
let map, marker;
function openDrawer(){ document.getElementById("drawer").classList.add("open"); setTimeout(()=>map?.invalidateSize(), 50); }
function closeDrawer(){ document.getElementById("drawer").classList.remove("open"); }
function initMap(lat=46.82, lon=-71.23){
  if(!map){
    map = L.map('minimap',{zoomControl:true}).setView([lat, lon], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    marker = L.marker([lat, lon],{draggable:true}).addTo(map);
    marker.on('dragend', ()=>{
      const p = marker.getLatLng();
      document.getElementById("lat").value = p.lat.toFixed(3);
      document.getElementById("lon").value = p.lng.toFixed(3);
    });
    map.on('click', (e)=>{
      marker.setLatLng(e.latlng);
      document.getElementById("lat").value = e.latlng.lat.toFixed(3);
      document.getElementById("lon").value = e.latlng.lng.toFixed(3);
    });
  }else{
    map.setView([lat,lon], map.getZoom());
    marker.setLatLng([lat,lon]);
  }
}
function useGeoloc(){
  const btn=document.getElementById("btnUseGeo"); btn.disabled=true;
  if(!navigator.geolocation){ btn.disabled=false; return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    document.getElementById("lat").value = lat.toFixed(3); document.getElementById("lon").value = lon.toFixed(3);
    initMap(lat, lon); btn.disabled=false;
  },()=>{ btn.disabled=false; }, {enableHighAccuracy:true, timeout:8000, maximumAge:300000});
}

// ------------- WIRING -------------
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("tzMode").value = fmt.tzMode;
  document.getElementById("tzMode").addEventListener("change", e=> setTzMode(e.target.value));
  document.getElementById("btnSettings").addEventListener("click", ()=> openDrawer());
  document.getElementById("closeDrawer").addEventListener("click", ()=> closeDrawer());
  document.getElementById("btnClose").addEventListener("click", ()=> closeDrawer());
  document.getElementById("btnUseGeo").addEventListener("click", useGeoloc);
  document.getElementById("btnApply").addEventListener("click", ()=>{
    const lat = parseFloat(document.getElementById("lat").value), lon = parseFloat(document.getElementById("lon").value);
    if(Number.isFinite(lat) && Number.isFinite(lon)){
      loadOvation(lat, lon);
      closeDrawer();
    }
  });

  // geolocate once to seed position
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition((pos)=>{
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      document.getElementById("lat").value = lat.toFixed(3); document.getElementById("lon").value = lon.toFixed(3);
      initMap(lat, lon);
      loadOvation(lat, lon);
    },()=>{
      initMap(); // default center
    }, {enableHighAccuracy:true, timeout:8000, maximumAge:300000});
  } else {
    initMap();
  }

  loadKpLive();
  loadKpForecast(false);
  setInterval(loadKpLive, 5*60*1000);
});
</script>
</body>
</html>
